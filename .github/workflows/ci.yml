name: CI - Unit Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  unit-tests-windows:
    name: Unit Tests (Windows)
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      timeout-minutes: 5
    
    - name: Verify dependencies
      run: |
        if (!(Test-Path "external\glfw\CMakeLists.txt")) {
          Write-Error "GLFW not found"
          exit 1
        }
        if (!(Test-Path "external\googletest\CMakeLists.txt")) {
          Write-Error "GoogleTest not found"
          exit 1
        }
        Write-Host "✓ Dependencies verified"
      shell: pwsh
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug
      timeout-minutes: 5
    
    - name: Build Unit Tests
      run: cmake --build build --config Debug --target HybridRenderer_unit_tests -j 4
      timeout-minutes: 10
    
    - name: Run Tests
      run: |
        cd build
        ctest -C Debug --output-on-failure --verbose
      timeout-minutes: 2

  unit-tests-linux:
    name: Unit Tests (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      timeout-minutes: 5
    
    - name: Install X11 dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libgl1-mesa-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libx11-dev
      timeout-minutes: 5
    
    - name: Verify dependencies
      run: |
        if [ ! -f "external/glfw/CMakeLists.txt" ]; then
          echo "ERROR: GLFW not found"
          exit 1
        fi
        if [ ! -f "external/googletest/CMakeLists.txt" ]; then
          echo "ERROR: GoogleTest not found"
          exit 1
        fi
        echo "✓ Dependencies verified"
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug
      timeout-minutes: 5
    
    - name: Build Unit Tests
      run: cmake --build build --config Debug --target HybridRenderer_unit_tests -j 4
      timeout-minutes: 10
    
    - name: List build artifacts (debug)
      run: |
        echo "Contents of build/bin:"
        ls -la build/bin/ || echo "build/bin does not exist"
        echo ""
        echo "Searching for test executable:"
        find build -name "*unit_tests*" -type f
    
    - name: Run Tests
      run: |
        cd build
        ctest --output-on-failure --verbose
      timeout-minutes: 2

  status:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests-windows, unit-tests-linux]
    if: always()
    
    steps:
    - name: Generate Summary
      run: |
        echo "# CI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.unit-tests-windows.result }}" == "success" ]; then
          echo "✅ **Windows Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Windows Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.unit-tests-linux.result }}" == "success" ]; then
          echo "✅ **Linux Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Linux Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- 49 unit tests (headless, no GPU)" >> $GITHUB_STEP_SUMMARY
        echo "- Tested on Windows and Linux" >> $GITHUB_STEP_SUMMARY
        echo "- Build time: ~2 minutes" >> $GITHUB_STEP_SUMMARY
        echo "- Test time: <1 second" >> $GITHUB_STEP_SUMMARY