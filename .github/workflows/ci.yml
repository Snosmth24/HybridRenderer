name: CI - Unit Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  unit-tests-windows:
    name: Unit Tests (Windows)
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      timeout-minutes: 5
    
    - name: Verify dependencies
      run: |
        if (!(Test-Path "external\glfw\CMakeLists.txt")) {
          Write-Error "GLFW not found"
          exit 1
        }
        if (!(Test-Path "external\googletest\CMakeLists.txt")) {
          Write-Error "GoogleTest not found"
          exit 1
        }
        Write-Host "✓ Dependencies verified"
      shell: pwsh
    
    - name: Check CMake version
      run: cmake --version
    
    - name: Configure
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug
      timeout-minutes: 5
    
    - name: Build
      run: cmake --build build --config Debug --target HybridRenderer_unit_tests
      timeout-minutes: 10
    
    - name: Run Tests
      run: .\build\bin\Debug\HybridRenderer_unit_tests.exe
      timeout-minutes: 2

 unit-tests-linux:
    name: Unit Tests (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        
        # Install X11 dependencies
        sudo apt-get install -y \
          libgl1-mesa-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev
        
        # Install Wayland dependencies (for GLFW)
        sudo apt-get install -y \
          libwayland-dev \
          wayland-protocols \
          libxkbcommon-dev
        
        echo "✓ Dependencies installed"
    
    - name: Verify dependencies
      run: |
        if [ ! -f "external/glfw/CMakeLists.txt" ]; then
          echo "ERROR: GLFW not found"
          exit 1
        fi
        if [ ! -f "external/googletest/CMakeLists.txt" ]; then
          echo "ERROR: GoogleTest not found"
          exit 1
        fi
        echo "✓ Dependencies verified"
    
    - name: Configure
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug
    
    - name: Build Unit Tests
      run: cmake --build build --config Debug --target HybridRenderer_unit_tests
    
    - name: Run Tests
      run: ./build/bin/Debug/HybridRenderer_unit_tests

  status:
    name: Status
    runs-on: ubuntu-latest
    needs: [unit-tests-windows, unit-tests-linux]
    if: always()
    
    steps:
    - name: Report
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.unit-tests-windows.result }}" == "success" ]; then
          echo "✅ Windows Tests: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Windows Tests: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.unit-tests-linux.result }}" == "success" ]; then
          echo "✅ Linux Tests: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Linux Tests: FAILED" >> $GITHUB_STEP_SUMMARY
        fi