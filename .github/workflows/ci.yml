name: CI - Unit Tests Only

on: [push, pull_request]

jobs:
  unit-tests-windows:
    name: Unit Tests (Windows)
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Verify dependencies
      run: |
        if (!(Test-Path "external\glfw\CMakeLists.txt")) {
          Write-Error "GLFW not found"
          exit 1
        }
        if (!(Test-Path "external\googletest\CMakeLists.txt")) {
          Write-Error "GoogleTest not found"
          exit 1
        }
        Write-Host "✓ Dependencies verified"
      shell: pwsh
    
    - name: Configure (Unit Tests Only)
      run: |
        # Create a minimal CMakeLists.txt that only builds unit tests
        cmake -B build -DCMAKE_BUILD_TYPE=Debug
      continue-on-error: true
    
    - name: Build Unit Tests Only
      run: |
        # Build ONLY the unit test target
        cmake --build build --config Debug --target HybridRenderer_unit_tests
    
    - name: Run Tests
      run: |
        cd build\bin\Debug
        .\HybridRenderer_unit_tests.exe

  unit-tests-linux:
    name: Unit Tests (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install X11 dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
    
    - name: Verify dependencies
      run: |
        if [ ! -f "external/glfw/CMakeLists.txt" ]; then
          echo "ERROR: GLFW not found"
          exit 1
        fi
        if [ ! -f "external/googletest/CMakeLists.txt" ]; then
          echo "ERROR: GoogleTest not found"
          exit 1
        fi
        echo "✓ Dependencies verified"
    
    - name: Configure (Unit Tests Only)
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug
      continue-on-error: true
    
    - name: Build Unit Tests Only
      run: cmake --build build --config Debug --target HybridRenderer_unit_tests
    
    - name: Run Tests
      run: ./build/bin/Debug/HybridRenderer_unit_tests